# Neo-DumasTrans

> 一个能精准解析文本及图片 PDF，进行大模型翻译和高保真排版，支持公式、表格、图片、超大文件、多页面混杂和复杂排版的 PDF 翻译软件。

---

## ✨ 核心功能

- **全自动端到端流水线**  
  从原始 PDF 输入到最终翻译脱敏 PDF 输出，全程无需人工干预。

- **多模态 PDF 支持**
  - `txt`：纯文本 PDF（直接提取）  
  - `ocr`：扫描/图像 PDF（本地 OCR 处理）  
  - `vlm`：调用 [MinerU](https://github.com/opendatalab/MinerU) 在线 API（支持公式、表格、复杂布局）

- **智能脱敏**  
  在原文文字、表格、公式区域用背景色精准“涂白”，生成干净底图（自动排除代码块）。

- **高保真译文叠加**  
  将翻译内容以透明图层形式精准覆盖于涂白 PDF 之上，100% 保留原始版式。

- **自动分块并行处理**  
  大文件按页切分（默认 25 页/块），支持高并发，避免内存溢出。

- **中间产物自动清理**  
  成功完成后自动删除临时文件，节省磁盘空间。

---

## 🚀 技术优势

### 1. 结构化 JSON 批量翻译，高效且防错乱
- 将多个可翻译单元（leaf blocks）打包为结构化 JSON 数组一次性提交至大模型。  
- 强制启用 JSON 模式（`response_format={ "type": "json_object" }`），确保返回格式严格对齐输入结构。  
- 显著降低 token 消耗（减少重复 prompt 开销），同时避免段落错位、标签丢失或顺序混乱。

### 2. 安全脱敏 + 图层合成
- 原文区域非简单删除，而是采样局部背景色进行智能填充（排除代码块等特殊区域）。  
- 最终 PDF = 涂白底图（隐藏原文） + 透明译文图层（Playwright 生成），兼顾隐私保护与阅读体验。

### 3. 双阶段字号与布局校准，确保零溢出
- **第一阶段（预估）**：使用 Pillow 对翻译文本进行字体宽度/高度粗略估算，初步确定字号上限。  
- **第二阶段（精校）**：通过 Playwright 启动真实浏览器，在 HTML 中动态测量实际渲染尺寸，并迭代调整字号或换行策略，确保内容 100% 落入原始 bbox 区域内，杜绝溢出、重叠或截断。

### 4. Playwright + Chromium 渲染，位置精准如原版
- 利用 Playwright 驱动 Google Chrome 将 HTML 转为 PDF。  
- 完全复用浏览器原生排版引擎，精确还原字体、间距、对齐、数学公式（MathJax）、表格等复杂元素。  
- 输出 PDF 具备像素级定位精度，视觉效果媲美人工排版。

---

## 📦 快速开始

### 下载免安装绿色 Windows 版（推荐）：
🔗 [百度网盘链接](https://pan.baidu.com/s/195dLoe-SbB4qv7zAvhZjxg?pwd=98yf)  
🔑 提取码：`98yf`

### 或手动安装依赖（不推荐）
- Python 3.10.11  
- Google Chrome（用于 Playwright）  
- （可选）MinerU API Key（仅 `vlm` 模式需要）
```bash
pip install -r requirements.txt
playwright install chromium
```

## ⚙️ 使用方式

双击根目录下 `run.bat` 文件启动图形界面。

---

## 🎯 适用场景

- 学术论文 / 技术文档的高质量翻译（保留公式、图表位置）  
- 扫描合同、报告的双语对照处理  
- 敏感信息文档的安全发布（隐藏原文，仅展示译文）  
- 文档本地化自动化流水线

---

## 🧱 架构特点

- **流水线式异步架构**：7 个阶段通过 `asyncio.Queue` 解耦，支持并发与错误隔离。  
- **模块化设计**：每个功能（MinerU、提取、翻译、涂白、渲染、PDF 转换、合并）均为独立模块。  
- **容错与跳过机制**：已处理文件自动跳过；单个 chunk 失败不影响整体流程。  
- **日志系统**：使用 `loguru` 记录详细执行状态。

---

## 💡 致谢

- [MinerU](https://github.com/opendatalab/MinerU)：强大的 PDF 结构化解析引擎  
- [Playwright](https://playwright.dev/)：可靠的浏览器自动化工具  
- [MathJax](https://www.mathjax.org/)：高质量数学公式渲染

